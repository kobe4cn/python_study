# 系统架构文档

## 概述

文档管理API是一个基于FastAPI构建的生产级后端系统，采用现代化的微服务架构设计，提供高性能、高可用的文档处理和语义搜索服务。

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │Web浏览器 │  │移动应用  │  │CLI工具   │  │第三方服务│       │
│  └─────┬────┘  └─────┬────┘  └─────┬────┘  └─────┬────┘       │
└────────┼─────────────┼─────────────┼─────────────┼─────────────┘
         │             │             │             │
         └─────────────┴─────────────┴─────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                    负载均衡层 (Nginx)                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  - HTTPS终止                                              │  │
│  │  - 请求路由                                               │  │
│  │  - SSL/TLS加密                                            │  │
│  │  - 静态资源缓存                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    应用层 (FastAPI)                              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    中间件栈                               │  │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐           │  │
│  │  │日志中间件  │ │安全中间件  │ │速率限制    │           │  │
│  │  └────────────┘ └────────────┘ └────────────┘           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    路由层                                 │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │  │
│  │  │认证路由  │ │文档路由  │ │搜索路由  │ │集合路由  │   │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    业务逻辑层                             │  │
│  │  ┌──────────────────┐  ┌──────────────────┐             │  │
│  │  │文档处理服务      │  │搜索服务          │             │  │
│  │  │- 文件上传        │  │- 语义搜索        │             │  │
│  │  │- URL加载         │  │- 批量搜索        │             │  │
│  │  │- 文档分割        │  │- 相似度搜索      │             │  │
│  │  │- 向量存储        │  │- 元数据过滤      │             │  │
│  │  └──────────────────┘  └──────────────────┘             │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    依赖注入层                             │  │
│  │  - 向量存储客户端                                         │  │
│  │  - 文档加载器                                             │  │
│  │  - 文档分割器                                             │  │
│  │  - Redis客户端                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    数据存储层                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   Qdrant     │  │    Redis     │  │  文件系统    │         │
│  │  向量数据库  │  │   缓存层     │  │  文件存储    │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    外部服务层                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  DashScope   │  │ Prometheus   │  │OpenTelemetry │         │
│  │  嵌入模型    │  │  监控指标    │  │  分布式追踪  │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 应用层 (FastAPI)

#### 1.1 中间件栈

- **日志中间件**: 记录所有HTTP请求和响应
- **安全中间件**:
  - CORS配置
  - 安全响应头
  - 请求验证
  - HTTPS重定向
- **速率限制**: 基于IP/用户的API调用限制

#### 1.2 路由层

```
/api/v1/
├── /auth/              # 认证相关
│   ├── POST /token     # 获取JWT令牌
│   └── POST /refresh   # 刷新令牌
├── /documents/         # 文档管理
│   ├── POST /upload    # 上传文件
│   ├── POST /from-url  # 从URL加载
│   └── DELETE /{id}    # 删除文档
├── /search/            # 搜索功能
│   ├── POST /          # 单个搜索
│   └── POST /batch     # 批量搜索
└── /collections/       # 集合管理
    ├── GET /           # 列出集合
    ├── GET /{name}/info # 集合详情
    └── DELETE /{name}  # 删除集合
```

#### 1.3 服务层

**DocumentService**
- 文件上传处理
- URL内容加载
- 文档分割
- 向量化存储

**SearchService**
- 语义搜索
- 批量搜索
- 相似文档查找
- 缓存管理

### 2. 数据存储层

#### 2.1 Qdrant (向量数据库)

- **用途**: 存储文档向量和元数据
- **特性**:
  - 高效的向量相似度搜索
  - 元数据过滤
  - 分布式部署支持
- **端口**: 6333 (HTTP), 6334 (gRPC)

#### 2.2 Redis (缓存层)

- **用途**: 缓存搜索结果和会话数据
- **特性**:
  - TTL自动过期
  - 高性能读写
  - 分布式锁
- **端口**: 6379

#### 2.3 文件系统

- **用途**: 临时存储上传的文件
- **路径**: `/app/uploads`
- **管理**: 定期清理策略

### 3. 外部服务

#### 3.1 DashScope (嵌入模型)

- **提供商**: 阿里云灵积
- **模型**: text-embedding-v4
- **用途**: 文本向量化

#### 3.2 Prometheus (监控)

- **端点**: `/metrics`
- **指标**:
  - HTTP请求计数
  - 请求延迟
  - 错误率
  - 自定义业务指标

#### 3.3 OpenTelemetry (追踪)

- **用途**: 分布式链路追踪
- **导出**: Jaeger/Zipkin兼容

## 数据流

### 文档上传流程

```
用户上传文件
    │
    ▼
验证文件类型和大小
    │
    ▼
保存到文件系统
    │
    ▼
加载文档内容
    │
    ▼
文档分割 (Chunking)
    │
    ▼
生成向量嵌入 (DashScope)
    │
    ▼
存储到Qdrant
    │
    ▼
返回文档ID列表
```

### 语义搜索流程

```
用户提交查询
    │
    ▼
检查缓存 (Redis)
    │
    ├─命中─> 返回缓存结果
    │
    ▼ 未命中
生成查询向量 (DashScope)
    │
    ▼
Qdrant向量搜索
    │
    ▼
应用元数据过滤
    │
    ▼
结果排序和格式化
    │
    ▼
写入缓存 (Redis)
    │
    ▼
返回搜索结果
```

## 安全架构

### 认证流程

```
┌──────────┐
│ 用户登录 │
└────┬─────┘
     │
     ▼
┌─────────────────┐
│验证用户名/密码   │
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│生成JWT令牌      │
│- Access Token   │
│- Refresh Token  │
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│返回令牌给客户端 │
└─────────────────┘
```

### 请求认证

```
客户端请求
    │
    ▼
提取Authorization Header
    │
    ▼
验证JWT令牌
    │
    ├─有效─> 提取用户信息
    │           │
    │           ▼
    │       检查权限
    │           │
    │           ▼
    │       执行业务逻辑
    │
    ▼ 无效
返回401错误
```

## 性能优化

### 1. 异步处理

- 所有I/O操作使用async/await
- 并发处理多个请求
- 非阻塞数据库查询

### 2. 缓存策略

```
┌─────────────┐
│  请求缓存   │
│  (Redis)    │
│  TTL: 5分钟 │
└─────────────┘
      │
      ▼
┌─────────────┐
│  应用缓存   │
│ (lru_cache) │
│  内存级别   │
└─────────────┘
```

### 3. 连接池

- Qdrant连接池: 最大100连接
- Redis连接池: 最大50连接
- HTTP客户端: 连接复用

### 4. 批处理

- 批量文档上传
- 批量向量化
- 批量搜索

## 扩展性

### 水平扩展

```
┌─────────┐
│Nginx LB │
└────┬────┘
     │
     ├──> API实例1 (Pod 1)
     ├──> API实例2 (Pod 2)
     ├──> API实例3 (Pod 3)
     └──> API实例N (Pod N)
```

### 垂直扩展

- 增加Worker进程数
- 增加CPU/内存资源
- 优化数据库配置

## 监控和日志

### 监控架构

```
FastAPI应用
    │
    ├──> Prometheus (指标收集)
    │       │
    │       ▼
    │   Grafana (可视化)
    │
    ├──> OpenTelemetry (追踪)
    │       │
    │       ▼
    │   Jaeger (追踪可视化)
    │
    └──> 结构化日志
            │
            ▼
        日志聚合系统
        (ELK/Loki)
```

### 关键指标

- **请求指标**:
  - RPS (每秒请求数)
  - 延迟分布 (P50, P95, P99)
  - 错误率

- **业务指标**:
  - 文档上传数
  - 搜索查询数
  - 向量存储大小

- **系统指标**:
  - CPU使用率
  - 内存使用率
  - 磁盘I/O

## 部署架构

### Docker部署

```
┌─────────────────────────────────┐
│     Docker Compose Stack        │
│  ┌──────────┐  ┌──────────┐    │
│  │  Nginx   │  │   API    │    │
│  └──────────┘  └──────────┘    │
│  ┌──────────┐  ┌──────────┐    │
│  │  Qdrant  │  │  Redis   │    │
│  └──────────┘  └──────────┘    │
└─────────────────────────────────┘
```

### Kubernetes部署

```
┌───────────────────────────────────┐
│        Kubernetes Cluster         │
│  ┌────────────────────────────┐  │
│  │  Ingress Controller        │  │
│  └───────────┬────────────────┘  │
│              │                    │
│  ┌───────────▼────────────────┐  │
│  │  API Deployment            │  │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ │
│  │  │ Pod1 │ │ Pod2 │ │ Pod3 │ │
│  │  └──────┘ └──────┘ └──────┘ │
│  └────────────────────────────┘  │
│  ┌────────────────────────────┐  │
│  │  StatefulSets              │  │
│  │  ┌────────┐  ┌─────────┐   │  │
│  │  │Qdrant  │  │ Redis   │   │  │
│  │  └────────┘  └─────────┘   │  │
│  └────────────────────────────┘  │
└───────────────────────────────────┘
```

## 故障恢复

### 高可用设计

1. **API层**: 多实例部署，无状态设计
2. **Qdrant**: 集群模式，数据副本
3. **Redis**: 主从复制，哨兵模式
4. **健康检查**: Kubernetes liveness/readiness探针

### 备份策略

- Qdrant数据: 每日快照
- Redis数据: AOF持久化
- 上传文件: 对象存储同步

## 总结

该架构具有以下特点:

1. **高性能**: 异步处理、缓存、连接池
2. **可扩展**: 水平/垂直扩展支持
3. **高可用**: 多实例、健康检查、故障转移
4. **安全**: 多层认证、加密传输、安全头
5. **可观测**: 完善的日志、监控、追踪
6. **易维护**: 清晰的分层、依赖注入、文档完整

适合生产环境部署，能够支撑大规模的文档处理和搜索请求。
